classdef LSLWrapper < handle
    %LSLWRAPPER Summary of this class goes here
    %   Detailed explanation goes here
    
    properties
        datastreaminfo;
        datainlet;
        eventstreaminfo;
        eventinlet;
        preprocessing;
        featextraction;
        classification; %pre-trained object required
    end
    
    properties (Access = private)
        lib;
        streamsOK;
        samplingRate;
    end
    
    methods
        function LSL = LSLWrapper()
            LSL.lib = lsl_loadlib;
            LSL.streamsOK = 0;
        end
        
        function LSL = resolveStreams(LSL,datastrem,maxbuffer,eventstream)
            LSL.datastreaminfo = lsl_resolve_byprop(LSL.lib, 'name', datastrem);
            LSL.eventstreaminfo = lsl_resolve_byprop(LSL.lib, 'name', eventstream);
            %get samplingRate from stream info 
            %samplingRate = ?
            if(length(LSL.datastreaminfo) > 0)
                LSL.datainlet = lsl_inlet(LSL.lib,LSL.datastreaminfo{1},maxbuffer);
            else
                error('Cannot resolve data stream');
            end
            if(length(LSL.eventstreaminfo) > 0)
                LSL.eventinlet = lsl_inlet(LSL.lib,LSL.eventstreaminfo{1});
            else
                error('Cannot resolve event stream');
            end
            LSL.streamsOK = 1;
        end
        
        function LSL = run(LSL,eventStopCode)
            if (LSL.streamsOK ~=1)
                error('error: Did you call \"resolveStreams\" ?');
            end
            while 1
                sample = LSL.eventinlet.pull_sample;
                if(sample==eventStopCode)
                    chunk = LSL.datainlet.pull_chunk;
                    trial = ssveptoolkit.util.Trial(chunk,0,LSL.samplingRate,0,0);
                    for i=1:length(LSL.preprocessing)
                        trial = LSL.preprocessing{i}.process(trial);
                    end
                    E.featextraction.trials = trial;
                    E.featextraction.extract;
                    [output, ~,~] = E.classification.classifyInstance(E.featextraction.getInstances);
                    disp(['classif output = ', num2str(output)]);
                end
            end
        end
            
    end
    
end

